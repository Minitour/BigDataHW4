<html>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script src='https://code.jquery.com/jquery-2.1.4.js'></script>
    
    <canvas id="line-chart" width="1000" height="600"></canvas>

    <script>
        
        // setting the current time stamp to the init of this script
        var currentTimestamp = new Date().getTime();

        // init general stock array to keep the data and not refresh every time
        var general_stocks = [];

        /*
            This function will get from the posted request the json with the stock data
            after getting the data the function will update the chart according to the new values
        */
        function getStocks() {
            var o = $.getJSON("mock_data.json", function(obj) {
                // console.log(obj);
                var stocks = [];
                var colors = [];
                var numberOfColors = obj.stocks.length;
                
                //var startFrom = getFirstIndex(obj.stocks);

                for (var i=0; i< numberOfColors; i++) {
                    colors.push(generateColor());
                }

                // iterate over the stock prices and construct the object to append the chart dataset
                for (var d in obj.stocks) {
                    var prices = [];
                    
                    // iterate over the prices and get the values if the time stamp is grater than now
                    for (var price in obj.stocks[d]['stockPrices']) {
                        if (obj.stocks[d]['stockPrices'][price]['timestamp'] > currentTimestamp)
                            prices.push(obj.stocks[d]['stockPrices'][price]['value']);
                    }

                    //construct the object to append if we have some new prices
                    if (prices.length > 0){
                        var s = {
                            data: prices,
                            label: obj.stocks[d]['symbol'],
                            borderColor: colors[d],
                            fill: false                        
                        };
                        // console.log(s);

                        // pushing the new data into the general stock array
                        general_stocks.push(s);
                        console.log("pushed");
                    }

                }

                var labels = getTimesForLabels();
                
                // updating the chart
                chart.data.datasets = general_stocks;
                chart.data.labels = labels;
                chart.update();

                currentTimestamp = new Date().getTime();
                console.log(currentTimestamp);

            });
        }
        
        // this function will generate colors according to the number of stocks
        function generateColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }

            return color;
        }

        /*
            This function will render the time labels in the bottom of the graph
        */
        function getTimesForLabels() {

            var d = new Date();
            var currentMinute = d.getMinutes();
            
            var times = [];
            
            // for every min we put label
            for (var i=60; i>0; i--) {
                if (currentMinute >= i) {
                    times.push(currentMinute - i);
                } else {
                    times.push(60-(i-currentMinute));
                }
                
            }
            return times;
        }

        // setting new chart with min initialization -> updating by posts
        var chart = new Chart(document.getElementById("line-chart"), {
            type: 'line',
            data: {datasets: null, labels: null},
            options: {
                title: {
                    display: true,
                    text: 'Popular Stocks On Tweeter'
                }
            }
        });

        // setting the interval for 1 sec to update the new stocks and prices from the posted request
        setInterval(function(){getStocks()}, 1000);

    </script>

</body>

</html>