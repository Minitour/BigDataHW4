<html>

<body>
    <!-- imports for chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script src='https://code.jquery.com/jquery-2.1.4.js'></script>
    <!-- <script src='./Chart.min.js'></script> -->

    <!-- import for tweet embedded element -->
    <script sync src="https://platform.twitter.com/widgets.js"></script>

    <div style="display:cell; overflow:auto;">
        <div style="float:right; padding-left:5px;">
            <canvas id="line-chart" width="1000" height="600"></canvas>
        </div>
        <div style="text-align: center; padding-right:5px;">
            <h3>Tweets</h3>
            <div id="tweet" style="text-align:center;"></div>

        </div>
    </div>


    <script>

        // setting the current time stamp to the init of this script
        // var currentTimestamp = 1547400798;
        var currentTimestamp = new Date().getTime();

        // init general stock array to keep the data and not refresh every time
        var generalForDataset = [];

        /*
            This function will get from the posted request the json with the stock data
            after getting the data the function will update the chart according to the new values
        */
       var index_for_loop = 0;
        function getStocks() {
            var settings = {
                "async": true,
                "crossDomain": false,
                "url": "http://localhost:5001/getData",
                "method": "POST",
                "headers": {
                    "content-type": "application/json",
                    "cache-control": "no-cache",
                    "Access-Control-Allow-Origin": "https://localhost:5001"
                }
            }

            $.ajax(settings).done(function (obj) {
                //console.log(obj);

                // init vars for colors
                var colors = [];
                var numberOfColors = Object.keys(obj.stocks).length;

                // generate colors by count of stocks
                for (var i = 0; i < numberOfColors; i++) {
                    colors.push(generateColor());
                }

                var indexForColor = 0;

                var stocks = obj.stocks;
                var tweets = obj.tweets;
                //console.log(tweets);

                // iterate over the stock prices and construct the object to append the chart dataset
                for (var d in stocks) {

                    var prices = [];
                    var isInStocks = false;


                    for (var i in generalForDataset) {
                        if (generalForDataset[i].label == d) {
                            for (var price in stocks[d]['stockPrices']) {
                                if (stocks[d]['stockPrices'][price]['timestamp'] > currentTimestamp) {
                                    generalForDataset[i].data.push({ "y": Math.floor(stocks[d]['stockPrices'][price]['value']), "x": stocks[d]['stockPrices'][price]['timestamp'] });

                                }
                            }
                            isInStocks = true;
                            chart.data.datasets = generalForDataset;
                        }
                    }

                    if (isInStocks == false) {

                        var tempPrices = [];
                        var iterPrices = stocks[d]['stockPrices'];

                        for (var price in iterPrices) {
                            if (iterPrices[price]['timestamp'] > currentTimestamp) {
                                prices.push({ "value": Math.floor(iterPrices[price]['value']), "timestamp": iterPrices[price]['timestamp'] });
                                tempPrices.push({ y: Math.floor(stocks[d]['stockPrices'][price]['value']), x: iterPrices[price]['timestamp'] });
                            }
                        }

                        if (tempPrices.length > 0) {

                            var s = {
                                data: tempPrices,
                                label: d,
                                borderColor: colors[indexForColor],
                                fill: false
                            };

                            // pushing the new data into the general stock array
                            generalForDataset.push(s);
                            chart.data.datasets = generalForDataset;
                            //console.log("pushed new stock");

                        }
                    }

                    indexForColor = indexForColor + 1;

                }

                //var labels = getTimesForLabels();
                var labels = [1, 2];
                chart.data.labels = labels;
                chart.update();

                currentTimestamp = new Date().getTime();
                //console.log(currentTimestamp);

                // setting up the tweets
                var tweet = document.getElementById("tweet");

                while( index_for_loop < 10) {
                    var id = tweets[index_for_loop]['tweet_id'];
                    //var id = "515490786800963584";

                    twttr.widgets.createTweet(
                        id, tweet,
                        {
                            conversation: 'none',    // or all
                            cards: 'hidden',  // or visible 
                            linkColor: '#cc0000', // default is blue
                            theme: 'light'    // or dark
                        })
                        .then(function (el) {
                            el.contentDocument.querySelector(".footer").style.display = "none";
                        });
                    
                    index_for_loop += 1;
                }

            });
        }


        // this function will generate colors according to the number of stocks
        function generateColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }

            return color;
        }

        // setting new chart with min initialization -> updating by posts
        var chart = new Chart(document.getElementById("line-chart"), {
            type: 'scatter',
            data: { datasets: null, labels: null },
            options: {
                title: {
                    display: true,
                    text: 'Popular Stocks On Tweeter'
                },
                scales: {
                    xAxes: [{
                        ticks: {
                            display: false //this will remove only the label
                        }
                    }]
                }
            }
        });

        // setting the interval for 1 sec to update the new stocks and prices from the posted request
        setInterval(function () { getStocks() }, 1000);

    </script>
    <script>

        // window.onload = (function () {
        //     var settings = {
        //         "async": true,
        //         "crossDomain": false,
        //         "url": "http://localhost:5001/getData",
        //         "method": "POST",
        //         "headers": {
        //             "content-type": "application/json",
        //             "cache-control": "no-cache",
        //             "Access-Control-Allow-Origin": "https://localhost:5423"
        //         }
        //     }



        //     $.ajax(settings).done(function (obj) {
        //         // console.log(obj);
        //         var tweets = obj.tweets;

        //         for (var t in tweets) {

        //             var id = tweets[t]['tweet_id'];

        //             twttr.widgets.createTweet(
        //                 id, tweet,
        //                 {
        //                     conversation: 'none',    // or all
        //                     cards: 'hidden',  // or visible 
        //                     linkColor: '#cc0000', // default is blue
        //                     theme: 'light'    // or dark
        //                 })
        //                 .then(function (el) {
        //                     el.contentDocument.querySelector(".footer").style.display = "none";
        //                 });
        //         }
        //     });
        // });

    </script>

</body>

</html>